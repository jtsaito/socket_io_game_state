<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 100; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      canvas { padding: 20px; position: fixed;  }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  </head>

  <body>


  <form id="player-form" action="">
    Player: <input type="text" id="player"><br>
    <input type="button" onclick="submitPlayer()" value="Submit">
  </form>

  <script>
    function submitPlayer() {
      var player = document.getElementById("player-form").elements[0].value;
      socket.emit('setPlayer', player);
    }
  </script>

  <canvas id="myCanvas" width="800" height="600" style="border:1px solid #c3c3c3;" >
    Your browser does not support the HTML5 canvas tag.
  </canvas>


  <script>
    var me = "";
    var world = { "p1": { x: 200, y: 200}, "p2": { x: 200, y: 400} };

    // Socket
    var socket = io();

    socket.on('world', function(new_world){
      world = new_world;
      render(world);
    });

    socket.on('setPlayer', function(remotePlayer){

      var localPlayer = $("#player").val();

      if(localPlayer === remotePlayer) {
        me = 'p1';
      }
      else {
        me = 'p2';
      }
      console.log("me: " + me);

    });

    // Canvas
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");

    document.addEventListener('keydown', function(e) {

      if (e.keyCode == 87) {  //  w key
        world[me].y = world[me].y - 10;
      }

      if (e.keyCode == 83) {  //  s key
        world[me].y = world[me].y + 10;
      }

      if (e.keyCode == 65) {  //  a key
        world[me].x = world[me].x - 10;
      }

      if (e.keyCode == 68) {  //  d key
        world[me].x = world[me].x + 10;
      }

      socket.emit('action', world);
    }, false);


    // World
    function render(world) {
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, 800, 600);
      render_player(world.p1, "#00ff00");
      render_player(world.p2, "#ff00ff");
      ctx.fillStyle = "#000000";
    };

    function render_player(player, color) {
      ctx.fillStyle = color;
      ctx.fillRect(player.x, player.y, 50, 30);
      ctx.fillStyle = "#000000";
    };

    render(world);


    // Speed test
    socket.on('speedTest', function(msg){
      console.log('on server: ' + (msg.on_server - msg.sent) + ' ms');
      console.log('on client: ' + (new Date().getTime() - msg.sent) + ' ms');
      console.log("---");
    });

    document.addEventListener('keydown', function(e) {
      if (e.keyCode == 88) {  //  x key
        socket.emit('speedTest', { sent: new Date().getTime() });
      }
    }, false);

  </script>

  </body>
</html>
